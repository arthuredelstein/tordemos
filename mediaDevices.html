<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8" />
  <title>MediaDevices fingerprinting</title>
 </head>
 <body>
   <script>
    const widthGreaterThan = async function (deviceId, threshold) {
      try {
        await navigator.mediaDevices.getUserMedia(
          { video : { deviceId,
                      width : { max : threshold },
                      frameRate : { max : 1 }}});
      } catch (e) {
        return (e.constraint === "width");
      }
    };

    const heightGreaterThan = async function (deviceId, threshold) {
      try {
        await navigator.mediaDevices.getUserMedia(
          { video : { deviceId,
                      height : { max : threshold },
                      frameRate : { max : 1 }}});
      } catch (e) {
        return (e.constraint === "height");
      }
    };

    const integerBinarySearch = async function integerBinarySearch (answerGreaterThan, [min, max]) {
      if (min === max) {
        return min;
      }
      let middle = Math.floor((min + max) / 2);
      let tooLow = await answerGreaterThan(middle);
      return await integerBinarySearch(answerGreaterThan,
                                       tooLow ? [middle + 1, max] : [min, middle]);
    }

    const getDimensions = async function (deviceId) {
      let width = await integerBinarySearch(w => widthGreaterThan(deviceId, w), [1, 20000]);
      let height = await integerBinarySearch(h => heightGreaterThan(deviceId, h), [1, 20000]);
      return { deviceId, width, height };
    };

    const getCameraDescriptors = async function () {
      let devices = await navigator.mediaDevices.enumerateDevices();
      let cameraIds = devices.filter(device => device.kind === "videoinput")
                             .map(camera => camera.deviceId);
      return cameraIds.map(getDimensions);
    }
   </script>
 </body>
</html>

